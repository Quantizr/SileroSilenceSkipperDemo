<!DOCTYPE html>
<html>
  <head>
    <title>Video with Speed Adjustment Based on Real-Time Voice Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ricky0123/vad-web/dist/bundle.min.js"></script>
  </head>
  <body>
    <p>SileroVAD takes around 10 seconds to load, if you start the video before that, video speed won't be adjusted until it loads.</p>
    <video id="video" width="640" height="360" controls crossOrigin="anonymous">
      <source src="https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/GoogleIO-2014-CastingToTheFuture.mp4" type="video/mp4">
    </video>
    <div id="playbackSpeed"></div>
    <br>
    <label for="playbackFast">Playback Fast:</label>
    <input type="range" min="0" max="10" step="0.1" value="3" id="playbackFast">
    <div id="playbackFastSetting"></div>
    <br>
    <label for="playbackSlow">Playback Slow:</label>
    <input type="range" min="0" max="5" step="0.1" value="1" id="playbackSlow">
    <div id="playbackSlowSetting"></div>
    <br>
    <label for="positiveSpeechThreshold">Positive Speech Threshold:</label>
    <input type="range" min="0" max="1" step="0.05" value="0.6" id="positiveSpeechThreshold">
    <div id="positiveSpeechThresholdSetting"></div>
    <br>
    <label for="negativeSpeechThreshold">Negative Speech Threshold:</label>
    <input type="range" min="0" max="1" step="0.05" value="0.4" id="negativeSpeechThreshold">
    <div id="negativeSpeechThresholdSetting"></div>
    <br>
    <label for="noSpeakingSampleThreshold">No speaking samples (at base speed):</label>
    <input type="range" min="1" max="10" step="1" value="4" id="noSpeakingSampleThreshold">
    <div id="noSpeakingSampleThresholdSetting"></div>
    <script>
      window.onload = function() {
        //ADJUSTABLE
        let playbackFast = 3.0;
        let playbackSlow = 1.0;
        let positiveSpeechThreshold = 0.6;
        let negativeSpeechThreshold = 0.4;
        let noSpeakingSampleThreshold = 4;
        //
        let playbackSpeed = 1.0;

        const playbackFastSlider = document.getElementById('playbackFast');
        const playbackSlowSlider = document.getElementById('playbackSlow');
        const positiveSpeechThresholdSlider = document.getElementById('positiveSpeechThreshold');
        const negativeSpeechThresholdSlider = document.getElementById('negativeSpeechThreshold');
        const playbackSpeedDisplay = document.getElementById('playbackSpeed');
        const noSpeakingSampleThresholdSlider = document.getElementById('noSpeakingSampleThreshold');

        playbackFastSlider.addEventListener('input', (e) => {
          playbackFast = e.target.value;
          playbackFastSetting.textContent = playbackFast;
        });

        playbackSlowSlider.addEventListener('input', (e) => {
          playbackSlow = e.target.value;
          playbackSlowSetting.textContent = playbackSlow;
        });

        positiveSpeechThresholdSlider.addEventListener('input', (e) => {
          positiveSpeechThreshold = e.target.value;
          positiveSpeechThresholdSetting.textContent = positiveSpeechThreshold;
        });

        negativeSpeechThresholdSlider.addEventListener('input', (e) => {
          negativeSpeechThreshold = e.target.value;
          negativeSpeechThresholdSetting.textContent = negativeSpeechThreshold;
        });

        noSpeakingSampleThresholdSlider.addEventListener('input', (e) => {
          noSpeakingSampleThreshold = e.target.value;
          noSpeakingSampleThresholdSetting.textContent = noSpeakingSampleThreshold;
        });

        playbackSpeedDisplay.textContent = `Playback Speed: ${playbackSpeed}`;
        playbackFastSetting.textContent = playbackFast;
        playbackSlowSetting.textContent = playbackSlow;
        positiveSpeechThresholdSetting.textContent = positiveSpeechThreshold;
        negativeSpeechThresholdSetting.textContent = negativeSpeechThreshold;
        noSpeakingSampleThresholdSetting.textContent = noSpeakingSampleThreshold;
        

        const video = document.getElementById("video");

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)({sampleRate: 44100}); //force sample rate so that frame sample time is consistent
        let source;
        let audioNodeVAD;
        let noSpeakingSamples = 0;
        let desyncCounter = 0;

        let vadStarted = false;

        async function startVAD() {
          if (vadStarted) return;
          audioNodeVAD = await vad.AudioNodeVAD.new(audioCtx, {
            frameSamples: 512, //11.61ms @ 44.1KHz, default value
            positiveSpeechThreshold: 1, //prevent default threshold from loading
            negativeSpeechThreshold: 0, //prevent default threshold from loading
            onFrameProcessed: (probabilities) => {
              //console.log("Frame processed", probabilities);
              if (probabilities.isSpeech > positiveSpeechThreshold && playbackSpeed != playbackSlow) {
                playbackSpeed = playbackSlow;
                video.playbackRate = playbackSpeed;
                playbackSpeedDisplay.textContent = `Playback Speed: ${playbackSpeed}`;
                noSpeakingSamples = 0;
                console.log("Speech started - slowing down")
              }

              if (probabilities.isSpeech < negativeSpeechThreshold && playbackSpeed != playbackFast) {
                noSpeakingSamples++;
                if (noSpeakingSamples >= Math.round(noSpeakingSampleThreshold/playbackSlow)) { //dynamically adjust silence gap based on video speed
                  playbackSpeed = playbackFast;
                  video.playbackRate = playbackSpeed;
                  playbackSpeedDisplay.textContent = `Playback Speed: ${playbackSpeed}`;
                  console.log("End of speech - speeding up")
                  desyncCounter++;
                  if (desyncCounter >= 10) {
                    video.currentTime += 1e-9;
                    desyncCounter = 0;
                    console.log("Resync video/audio")
                  }
                }
              }

            }
          });
          vadStarted = true;
        }

        startVAD();


        video.addEventListener("play", function() {
          if (!source) {
            audioCtx.resume();
            source = audioCtx.createMediaElementSource(video);
            source.connect(audioCtx.destination);

            // source = new MediaStreamAudioSourceNode(audioCtx, {
            //   mediaStream: video.captureStream(),
            // })

            startVAD().then(() => {
              audioNodeVAD.receive(source);
              audioNodeVAD.start();
            })
          } else {
            audioNodeVAD.start();
          } 
        });

        video.addEventListener("pause", () => {
          audioNodeVAD.pause();
        });
      };
    </script>
  </body>
</html>
